CREATE DATABASE DETHITHU
GO
USE DETHITHU
-- DROP DATABASE DETHITHU
GO

CREATE TABLE LOP
(
    MALOP VARCHAR(5) PRIMARY KEY,
    TENLOP VARCHAR(40),
    TRGLOP VARCHAR(5),
    SISO TINYINT,
    -- CONSTRAINT FK_LOP_TRGLOP FOREIGN KEY(TRGLOP) REFERENCES HOCVIEN(MAHV)
)
GO
CREATE TABLE HOCVIEN
(
    MAHV VARCHAR(5) PRIMARY KEY,
    HO VARCHAR(10),
    TEN VARCHAR(10),
    NGSINH smalldatetime,
    GIOITINH VARCHAR(10),
    MALOP VARCHAR(5),
    -- CONSTRAINT FK_HOCVIEN_MALOP FOREIGN KEY(MALOP) REFERENCES LOP(MALOP)
)
GO
CREATE TABLE KHOA
(
    MAKHOA VARCHAR(5) PRIMARY KEY,
    TENKHOA VARCHAR(10),

)
GO
CREATE TABLE MONHOC
(
    MAMH VARCHAR(10) PRIMARY KEY,
    TENMH VARCHAR(40),
    TCLT TINYINT,
    TCTH TINYINT,
    MAKHOA VARCHAR(5),
    CONSTRAINT FK_MONHOC_MAKHOA FOREIGN KEY(MAKHOA) REFERENCES KHOA(MAKHOA)

)
GO
CREATE TABLE KETQUATHI
(
    MAHV VARCHAR(5),
    MAMH VARCHAR(10),
    LANTHI TINYINT,
    NGTHI smalldatetime,
    DIEM NUMERIC(4,2),
    KQUA VARCHAR(10),
    CONSTRAINT PK_KETQUATHI_MAHV_MAH_LANTHI PRIMARY KEY (MAHV, MAMH, LANTHI),
    CONSTRAINT FK_KETQUATHI_MAMH FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH),
)
GO

GO
INSERT INTO LOP
    (MALOP,TENLOP,TRGLOP,SISO)
VALUES
    ('ML01', 'LOP1', 'HV02', 30)
INSERT INTO LOP
    (MALOP,TENLOP,TRGLOP,SISO)
VALUES
    ('ML02', 'LOP2', 'HV02', 35)
INSERT INTO LOP
    (MALOP,TENLOP,TRGLOP,SISO)
VALUES
    ('ML03', 'LOP2', 'HV01', 36)
INSERT INTO LOP
    (MALOP,TENLOP,TRGLOP,SISO)
VALUES
    ('ML04', 'LOP3', 'HV03', 40)
INSERT INTO LOP
    (MALOP,TENLOP,TRGLOP,SISO)
VALUES
    ('ML05', 'LOP3', 'HV04', 45)
INSERT INTO LOP
    (MALOP,TENLOP,TRGLOP,SISO)
VALUES
    ('ML06', 'LOP3', 'HV05', 50)
INSERT INTO LOP
    (MALOP,TENLOP,TRGLOP,SISO)
VALUES
    ('ML07', 'LOP4', 'HV06', 60)
GO
INSERT INTO HOCVIEN
    (MAHV, HO, TEN, NGSINH, GIOITINH, MALOP)
VALUES('HV01', 'H1', 'T1', '3/11/2020', 'nam', 'ML01')
INSERT INTO HOCVIEN
    (MAHV, HO, TEN, NGSINH, GIOITINH, MALOP)
VALUES('HV02', 'H2', 'T2', '4/11/2020', 'nam', 'ML01')
INSERT INTO HOCVIEN
    (MAHV, HO, TEN, NGSINH, GIOITINH, MALOP)
VALUES('HV03', 'H3', 'T3', '5/11/2020', 'nu', 'ML02')
INSERT INTO HOCVIEN
    (MAHV, HO, TEN, NGSINH, GIOITINH, MALOP)
VALUES('HV04', 'H4', 'T4', '6/11/2020', 'nam', 'ML01')
INSERT INTO HOCVIEN
    (MAHV, HO, TEN, NGSINH, GIOITINH, MALOP)
VALUES('HV05', 'H5', 'T5', '7/11/2020', 'nu', 'ML07')
INSERT INTO HOCVIEN
    (MAHV, HO, TEN, NGSINH, GIOITINH, MALOP)
VALUES('HV06', 'H6', 'T6', '8/11/2020', 'nu', 'ML06')
GO
ALTER TABLE HOCVIEN ADD CONSTRAINT FK_HOCVIEN_MALOP FOREIGN KEY(MALOP) REFERENCES LOP(MALOP)
ALTER TABLE LOP ADD CONSTRAINT FK_LOP_TRGLOP FOREIGN KEY(TRGLOP) REFERENCES HOCVIEN(MAHV)
ALTER TABLE KETQUATHI ADD CONSTRAINT FK_KETQUATHI_MAHV FOREIGN KEY(MAHV) REFERENCES HOCVIEN(MAHV)
GO
INSERT INTO KHOA
    (MAKHOA, TENKHOA)
VALUES('K01', 'HTTT')
INSERT INTO KHOA
    (MAKHOA, TENKHOA)
VALUES('K02', 'KTPM')
INSERT INTO KHOA
    (MAKHOA, TENKHOA)
VALUES('K03', 'ATTT')
INSERT INTO KHOA
    (MAKHOA, TENKHOA)
VALUES('K04', 'KHMT')
INSERT INTO KHOA
    (MAKHOA, TENKHOA)
VALUES('K05', 'KTMT')
GO
INSERT INTO MONHOC
    (MAMH, TENMH, TCLT, TCTH, MAKHOA)
VALUES('MH01', 'TMH1', 2, 2, 'K01')
INSERT INTO MONHOC
    (MAMH, TENMH, TCLT, TCTH, MAKHOA)
VALUES('MH02', 'TMH2', 2, 3, 'K01')
INSERT INTO MONHOC
    (MAMH, TENMH, TCLT, TCTH, MAKHOA)
VALUES('MH03', 'TMH3', 1, 2, 'K02')
INSERT INTO MONHOC
    (MAMH, TENMH, TCLT, TCTH, MAKHOA)
VALUES('MH04', 'TMH4', 5, 2, 'K02')
INSERT INTO MONHOC
    (MAMH, TENMH, TCLT, TCTH, MAKHOA)
VALUES('MH05', 'TMH5', 3, 3, 'K03')
INSERT INTO MONHOC
    (MAMH, TENMH, TCLT, TCTH, MAKHOA)
VALUES('MH06', 'TMH6', 2, 1, 'K03')
INSERT INTO MONHOC
    (MAMH, TENMH, TCLT, TCTH, MAKHOA)
VALUES('MH07', 'TMH7', 5, 2, 'K04')
INSERT INTO MONHOC
    (MAMH, TENMH, TCLT, TCTH, MAKHOA)
VALUES('MH08', 'TMH8', 2, 3, 'K05')
GO
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV01', 'MH01', 2, '01/02/2002', 9, 'DAT' )
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV01', 'MH03', 1, '01/02/2002', 2, 'KDAT' )
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV01', 'MH08', 2, '01/02/2002', 9, 'DAT' )
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV02', 'MH02', 3, '01/02/2002', 5, 'DAT' )
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV02', 'MH03', 4, '01/02/2002', 6, 'KDAT' )
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV02', 'MH04', 5, '01/02/2002', 1, 'DAT' )
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV03', 'MH04', 1, '01/02/2002', 10, 'DAT' )
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV03', 'MH05', 2, '01/02/2002', 10, 'DAT' )
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV04', 'MH02', 5, '01/02/2002', 6, 'KDAT' )
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV04', 'MH01', 3, '01/02/2002', 9, 'DAT' )
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV06', 'MH02', 6, '01/02/2002', 8, 'DAT' )
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV06', 'MH03', 7, '01/02/2002', 7, 'KDAT' )
INSERT INTO KETQUATHI
    (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA)
VALUES('HV06', 'MH04', 8, '01/02/2002', 4, 'KDAT' )

-- USE SACH
-- DROP DATABASE DETHITHU

SELECT MAHV, HO, TEN, NGSINH, LOP.MALOP
FROM LOP, HOCVIEN
WHERE LOP.TRGLOP = HOCVIEN.MAHV


SELECT MAMH, COUNT(MAHV)
FROM KETQUATHI KQ
WHERE KQ.KQUA='DAT'
GROUP BY KQ.MAMH

    SELECT MAHV, HO, TEN
    FROM HOCVIEN
EXCEPT
    SELECT MAHV, HO, TEN
    FROM HOCVIEN
    WHERE MAHV IN (
    SELECT MAHV
    FROM KETQUATHI
)

SELECT HV.MAHV, HO, TEN
FROM HOCVIEN HV
WHERE NOT EXISTS(
    SELECT *
FROM MONHOC MH
WHERE NOT EXISTS(
        SELECT *
FROM KETQUATHI KQ
WHERE (KQ.MAHV=HV.MAHV AND MH.MAMH=KQ.MAMH) AND KQUA='DAT' AND LANTHI=2 AND MAKHOA='HTTT'
    ))



SELECT L1.MALOP, HV.HO, HV.TEN, COUNT(KQ.MAMH)
FROM HOCVIEN HV, KETQUATHI KQ, LOP L1
WHERE HV.MALOP = L1.MALOP AND KQ.MAHV = HV.MAHV AND (KQ.DIEM=9 OR KQ.DIEM = 10)
GROUP BY L1.MALOP, HV.HO, HV.TEN
HAVING COUNT(KQ.MAMH) >= ALL(
    SELECT COUNT(KQ.MAMH)
    FROM HOCVIEN HV, KETQUATHI KQ, LOP L2
    WHERE HV.MALOP = L2.MALOP AND KQ.MAHV = HV.MAHV AND (KQ.DIEM=9 OR KQ.DIEM = 10)
    GROUP BY L2.MALOP, HO,TEN
    HAVING L1.MALOP = L2.MALOP
)

SELECT L1.MALOP, HV.HO, HV.TEN, COUNT(KQ.MAMH)
FROM HOCVIEN HV, KETQUATHI KQ, LOP L1
WHERE HV.MALOP = L1.MALOP AND KQ.MAHV = HV.MAHV 
GROUP BY L1.MALOP, HV.HO, HV.TEN
HAVING COUNT(KQ.MAMH) >= ALL(
    SELECT COUNT(KQ.MAMH)
    FROM HOCVIEN HV, KETQUATHI KQ, LOP L2
    WHERE HV.MALOP = L2.MALOP AND KQ.MAHV = HV.MAHV
    GROUP BY L2.MALOP
    HAVING L1.MALOP = L2.MALOP
)
