CREATE DATABASE SACH
GO
USE SACH
GO
CREATE TABLE TACGIA
(
    MaTG CHAR(5) PRIMARY KEY,
    HoTen VARCHAR(20),
    DiaChi VARCHAR(50),
    NgSinh smalldatetime,
    SoDT VARCHAR(15),
)
GO
CREATE TABLE SACH
(
    MaSach CHAR(5) PRIMARY KEY,
    TenSach VARCHAR(25),
    TheLoai VARCHAR(25),
)
GO
CREATE TABLE TACGIA_SACH
(
    MaTG CHAR(5) ,
    MaSach CHAR(5),
    CONSTRAINT TACGIA_SACH_MaTG_MaSach_PK PRIMARY KEY(MaTG, MaSach),
    CONSTRAINT TACGIA_SACH_MaTG_FK FOREIGN KEY (MaTG) REFERENCES TACGIA(MaTG),
    CONSTRAINT TACGIA_SACH_MaSach_FK FOREIGN KEY (MaSach) REFERENCES SACH(MaSach)
)
GO
CREATE TABLE PHATHANH
(
    MaPH CHAR(5) PRIMARY KEY,
    MaSach CHAR(5),
    NgayPH smalldatetime,
    SoLuong INT,
    NhaXuatBan VARCHAR(20),
    CONSTRAINT PHATHANH_MaSach_FK FOREIGN KEY (MaSach) REFERENCES SACH(MaSach)
)
GO
-- TAC GIA VALUES
-- INSERT INTO TACGIA
--     (MaTG, HoTen, DiaChi, NgSinh, SoDT)
-- VALUES('TG01', 'TGA', '123/A', '01/01/2001', '001')
-- INSERT INTO TACGIA
--     (MaTG, HoTen, DiaChi, NgSinh, SoDT)
-- VALUES('TG02', 'TGB', '123/B', '02/01/2001', '002')
-- INSERT INTO TACGIA
--     (MaTG, HoTen, DiaChi, NgSinh, SoDT)
-- VALUES('TG03', 'TGC', '123/C', '03/01/2001', '003')
-- INSERT INTO TACGIA
--     (MaTG, HoTen, DiaChi, NgSinh, SoDT)
-- VALUES('TG04', 'TGD', '123/D', '04/01/2001', '004')
-- INSERT INTO TACGIA
--     (MaTG, HoTen, DiaChi, NgSinh, SoDT)
-- VALUES('TG05', 'TGE', '123/E', '05/01/2001', '005')
-- INSERT INTO TACGIA
--     (MaTG, HoTen, DiaChi, NgSinh, SoDT)
-- VALUES('TG06', 'TGF', '123/F', '06/01/2001', '006')
-- INSERT INTO TACGIA
--     (MaTG, HoTen, DiaChi, NgSinh, SoDT)
-- VALUES('TG07', 'TGG', '123/G', '07/01/2001', '007')

-- -- SACH VALUES
-- INSERT INTO SACH
--     (MaSach, TenSach, TheLoai)
-- VALUES('S01', 'SACH1', 'TL1')
-- INSERT INTO SACH
--     (MaSach, TenSach, TheLoai)
-- VALUES('S02', 'SACH2', 'TL2')
-- INSERT INTO SACH
--     (MaSach, TenSach, TheLoai)
-- VALUES('S03', 'SACH3', 'GIAOKHOA')
-- INSERT INTO SACH
--     (MaSach, TenSach, TheLoai)
-- VALUES('S04', 'SACH4', 'TL4')
-- INSERT INTO SACH
--     (MaSach, TenSach, TheLoai)
-- VALUES('S05', 'SACH5', 'GIAOKHOA')
-- INSERT INTO SACH
--     (MaSach, TenSach, TheLoai)
-- VALUES('S06', 'SACH6', 'TL6')
-- INSERT INTO SACH
--     (MaSach, TenSach, TheLoai)
-- VALUES('S07', 'SACH7', 'TL7')

-- -- TAC GIA SACH VALUES
-- INSERT INTO TACGIA_SACH
--     (MaTG, MaSach)
-- VALUES('TG01', 'S01')
-- INSERT INTO TACGIA_SACH
--     (MaTG, MaSach)
-- VALUES('TG02', 'S02')
-- INSERT INTO TACGIA_SACH
--     (MaTG, MaSach)
-- VALUES('TG03', 'S03')
-- INSERT INTO TACGIA_SACH
--     (MaTG, MaSach)
-- VALUES('TG04', 'S04')
-- INSERT INTO TACGIA_SACH
--     (MaTG, MaSach)
-- VALUES('TG05', 'S05')
-- INSERT INTO TACGIA_SACH
--     (MaTG, MaSach)
-- VALUES('TG06', 'S06')
-- INSERT INTO TACGIA_SACH
--     (MaTG, MaSach)
-- VALUES('TG07', 'S07')

-- -- PHATHANH VALUES
-- INSERT INTO PHATHANH
--     (MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan)
-- VALUES('PH01', 'S01', '01/02/2001', 1, 'NhaXB1')
-- INSERT INTO PHATHANH
--     (MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan)
-- VALUES('PH02', 'S02', '02/02/2001', 2, 'NhaXB2')
-- INSERT INTO PHATHANH
--     (MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan)
-- VALUES('PH03', 'S03', '03/02/2001', 3, 'NhaXB3')
-- INSERT INTO PHATHANH
--     (MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan)
-- VALUES('PH04', 'S04', '04/02/2001', 4, 'NhaXB4')
-- INSERT INTO PHATHANH
--     (MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan)
-- VALUES('PH05', 'S05', '05/02/2001', 5, 'NhaXB5')
-- INSERT INTO PHATHANH
--     (MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan)
-- VALUES('PH06', 'S06', '06/02/2001', 6, 'NhaXB6')
-- INSERT INTO PHATHANH
--     (MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan)
-- VALUES('PH07', 'S07', '07/02/2001', 7, 'NhaXB7')
-- INSERT INTO PHATHANH
--     (MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan)
-- VALUES('PH08', 'S03', '07/02/2001', 7, 'NhaXB7')
-- INSERT INTO PHATHANH
--     (MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan)
-- VALUES('PH09', 'S02', '07/02/2001', 7, 'NhaXB7')
SET DATEFORMAT DMY
INSERT INTO TACGIA
    (MATG,HOTEN,DIACHI,NGSINH,SODT)
VALUES
    ('TG01', 'PHAM THANH BINH', '123/4 CAO CHUONG', '15/04/1993', '0902444222')
INSERT INTO TACGIA
    (MATG,HOTEN,DIACHI,NGSINH,SODT)
VALUES
    ('TG02', 'PHAM THANH THAO', '133/4 CAO CHUONG', '16/04/1993', '0902444223')
INSERT INTO TACGIA
    (MATG,HOTEN,DIACHI,NGSINH,SODT)
VALUES
    ('TG03', 'PHAM THANH ACH', '134/4 CAO CHUONG', '17/04/1993', '0902444224')
INSERT INTO TACGIA
    (MATG,HOTEN,DIACHI,NGSINH,SODT)
VALUES
    ('TG04', 'PHAM THANH NEV', '135/4 CAO CHUONG', '18/04/1993', '0902444252')
INSERT INTO TACGIA
    (MATG,HOTEN,DIACHI,NGSINH,SODT)
VALUES
    ('TG05', 'PHAM THANH BAO', '149/4 CAO CHUONG', '19/04/1993', '0902444226')
INSERT INTO TACGIA
    (MATG,HOTEN,DIACHI,NGSINH,SODT)
VALUES
    ('TG06', 'PHAM THANH KHOA', '120/5 CAO CHUONG', '20/04/1993', '0902444227')
INSERT INTO TACGIA
    (MATG,HOTEN,DIACHI,NGSINH,SODT)
VALUES
    ('TG07', 'PHAM THANH CHUONG', '164/7 CAO CHUONG', '21/04/1993', '0902444228')
INSERT INTO TACGIA
    (MATG,HOTEN,DIACHI,NGSINH,SODT)
VALUES
    ('TG08', 'PHAM THANH HOANG', '304/4 CAO CHUONG', '22/04/1993', '0902444229')
INSERT INTO TACGIA
    (MATG,HOTEN,DIACHI,NGSINH,SODT)
VALUES
    ('TG09', 'PHAM THANH PHUC', '159/4 CAO CHUONG', '23/04/1993', '0902410222')
INSERT INTO TACGIA
    (MATG,HOTEN,DIACHI,NGSINH,SODT)
VALUES
    ('TG10', 'PHAM THANH NHAN', '170/4 CAO CHUONG', '24/04/1993', '0902411222')

INSERT INTO SACH
    (MASACH,TENSACH,THELOAI)
VALUES('S1', 'DACNHANTAM1', 'VANHOC')
INSERT INTO SACH
    (MASACH,TENSACH,THELOAI)
VALUES('S2', 'DACNHANTAM2', 'TRUYENCUOI')
INSERT INTO SACH
    (MASACH,TENSACH,THELOAI)
VALUES('S3', 'DACNHANTAM3', 'VANHOC')
INSERT INTO SACH
    (MASACH,TENSACH,THELOAI)
VALUES('S4', 'DACNHANTAM4', 'GIAOKHOA')
INSERT INTO SACH
    (MASACH,TENSACH,THELOAI)
VALUES('S5', 'DACNHANTAM5', 'VANHOC')
INSERT INTO SACH
    (MASACH,TENSACH,THELOAI)
VALUES('S6', 'DACNHANTAM6', 'VANHOC')
INSERT INTO SACH
    (MASACH,TENSACH,THELOAI)
VALUES('S7', 'DACNHANTAM7', 'CHUAHE')
INSERT INTO SACH
    (MASACH,TENSACH,THELOAI)
VALUES('S8', 'DACNHANTAM8', 'VANHOC')
INSERT INTO SACH
    (MASACH,TENSACH,THELOAI)
VALUES('S9', 'DACNHANTAM9', 'MANHKHOA')
INSERT INTO SACH
    (MASACH,TENSACH,THELOAI)
VALUES('S10', 'DACNHANTAM10', 'VANHOC')


INSERT INTO TACGIA_SACH
    (MATG,MASACH)
VALUES('TG01', 'S1')
INSERT INTO TACGIA_SACH
    (MATG,MASACH)
VALUES('TG02', 'S2')
INSERT INTO TACGIA_SACH
    (MATG,MASACH)
VALUES('TG03', 'S3')
INSERT INTO TACGIA_SACH
    (MATG,MASACH)
VALUES('TG04', 'S4')
INSERT INTO TACGIA_SACH
    (MATG,MASACH)
VALUES('TG05', 'S5')
INSERT INTO TACGIA_SACH
    (MATG,MASACH)
VALUES('TG06', 'S6')
INSERT INTO TACGIA_SACH
    (MATG,MASACH)
VALUES('TG07', 'S7')
INSERT INTO TACGIA_SACH
    (MATG,MASACH)
VALUES('TG08', 'S8')
INSERT INTO TACGIA_SACH
    (MATG,MASACH)
VALUES('TG09', 'S9')
INSERT INTO TACGIA_SACH
    (MATG,MASACH)
VALUES('TG10', 'S10')

INSERT INTO PHATHANH
    (MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN)
VALUES('PH1', 'S1', '1/1/2020', '100', 'TRE')
INSERT INTO PHATHANH
    (MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN)
VALUES('PH2', 'S2', '2/1/2020', '100', 'TRE')
INSERT INTO PHATHANH
    (MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN)
VALUES('PH3', 'S3', '3/1/2020', '110', 'TRE')
INSERT INTO PHATHANH
    (MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN)
VALUES('PH4', 'S4', '4/1/2020', '130', 'TRE')
INSERT INTO PHATHANH
    (MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN)
VALUES('PH5', 'S5', '5/1/2020', '150', 'GIA')
INSERT INTO PHATHANH
    (MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN)
VALUES('PH6', 'S6', '6/1/2020', '200', 'TRE')
INSERT INTO PHATHANH
    (MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN)
VALUES('PH7', 'S7', '7/1/2020', '100', 'TRE')
INSERT INTO PHATHANH
    (MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN)
VALUES('PH8', 'S8', '8/1/2020', '101', 'GIA')
INSERT INTO PHATHANH
    (MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN)
VALUES('PH9', 'S9', '9/1/2020', '109', 'TRE')
INSERT INTO PHATHANH
    (MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN)
VALUES('PH10', 'S10', '10/1/2020', '100', 'DHQG')
-- use SQLDB1
-- DROP DATABASE SACH

SELECT TG.MaTG, HoTen, SoDT
FROM SACH, TACGIA TG, TACGIA_SACH TGS
WHERE TG.MaTG = TGS.MaTG AND TGS.MaSach =  SACH.MaSach and SACH.TheLoai='GIAOKHOA'


SELECT PH.NhaXuatBan, COUNT( DISTINCT SACH.TheLoai)
FROM PHATHANH PH, SACH
WHERE PH.MaSach = SACH.MaSach
GROUP BY PH.NhaXuatBan
HAVING COUNT ( DISTINCT SACH.TheLoai)>=all( 
SELECT COUNT( DISTINCT SACH.TheLoai)
FROM PHATHANH PH, SACH
WHERE PH.MaSach = SACH.MaSach
GROUP BY PH.NhaXuatBan
);

-- Tung nha xuat ban, ma tg co so lan phat hanh lon nhat
SELECT P1.NHAXUATBAN, T.MATG, HOTEN, COUNT(P1.MaPH)
FROM TACGIA T, PHATHANH P1, TACGIA_SACH TGS
WHERE TGS.MATG=T.MATG AND P1.MASACH=TGS.MASACH
GROUP BY P1.NHAXUATBAN,T.MATG,T.HOTEN
HAVING COUNT(P1.MaPH)>= all(
SELECT count(P2.MaPH)
FROM PHATHANH P2, TACGIA T, TACGIA_SACH TGS
WHERE TGS.MATG=T.MATG AND P2.MASACH=TGS.MASACH
GROUP BY P2.NHAXUATBAN,T.MATG,T.HOTEN
HAVING P1.NhaXuatBan=P2.NhaXuatBan
)
