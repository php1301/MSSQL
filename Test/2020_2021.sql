CREATE DATABASE BAITHI1
GO
USE BAITHI1
CREATE TABLE THISINH
(
    SOBD CHAR(5) PRIMARY KEY,
    HOTEN VARCHAR(255),
    NGSINH SMALLDATETIME,
    CAPDO INT,
)

CREATE TABLE CAUHOI
(
    MACH CHAR(5) PRIMARY KEY,
    NOIDUNGCH VARCHAR(255),
    DIEM INT,
    DOKHO INT,
)

CREATE TABLE PHUONGAN
(
    MAPA CHAR(5) PRIMARY KEY,
    NOIDUNGPA VARCHAR(255),
    MACH CHAR(5),
    LADAPAN INT,
    CONSTRAINT FK_PA_MACH FOREIGN KEY (MACH) REFERENCES CAUHOI(MACH),
)

CREATE TABLE TRALOI
(
    SOBD CHAR(5),
    MACH CHAR(5),
    MAPA CHAR(5),
    CONSTRAINT PK_SOBD_MACH PRIMARY KEY (SOBD,MACH),
    CONSTRAINT FK_TL_MACH FOREIGN KEY (MACH) REFERENCES CAUHOI(MACH),
    CONSTRAINT FK_TL_SOBD FOREIGN KEY (SOBD) REFERENCES THISINH(SOBD),
    CONSTRAINT FK_TL_MAPA FOREIGN KEY (MAPA) REFERENCES PHUONGAN(MAPA),
)

-- USE DE1920
-- DROP DATABASE BAITHI1

GO
CREATE TRIGGER TG1 ON CAUHOI
FOR INSERT, UPDATE 
AS
BEGIN
    DECLARE @DOKHO INT, @DIEM INT
    SELECT @DOKHO = DOKHO, @DIEM = DIEM
    FROM INSERTED
    IF(@DOKHO < 3 AND @DIEM < 20)
    BEGIN
        PRINT 'CAU HOI DO KHO BE HON 3 THI PHAI CO DIEM >= 20'
        ROLLBACK TRANSACTION
    END
    ELSE 
    BEGIN
        PRINT 'THANH CONG'
    END
END


GO
CREATE TRIGGER TG2 ON PHUONGAN
for INSERT, UPDATE
AS 
BEGIN
    DECLARE @SOPHUONGAN INT, @MACH CHAR(5)
    SELECT @MACH = MACH
    FROM inserted
    set @SOPHUONGAN = (select COUNT(*)
    FROM CAUHOI CH, PHUONGAN PA
    WHERE PA.MACH = @MACH AND PA.LADAPAN = 1 and CH.MACH = @MACH)

    IF(@SOPHUONGAN > 1)
    BEGIN
        PRINT 'MOI CAU HOI CHI DUOC PHEP CO 1 DAP AN'
        ROLLBACK TRANSACTION
    END
    ELSE 
    BEGIN
        PRINT 'TAC VU PHUONG AN THANH CONG'
    END
END
GO
SET DATEFORMAT DMY
GO
INSERT INTO THISINH
    (SOBD, HOTEN, NGSINH, CAPDO)
VALUES('TS001', 'NVA', '02/10/2000', 2)
INSERT INTO THISINH
    (SOBD, HOTEN, NGSINH, CAPDO)
VALUES('TS002', 'NVB', '17/03/1999', 3)
INSERT INTO THISINH
    (SOBD, HOTEN, NGSINH, CAPDO)
VALUES('TS003', 'NVC', '08/03/2001', 5)

INSERT INTO CAUHOI
    (MACH, NOIDUNGCH,DIEM, DOKHO)
VALUES('CH01', 'ABC', 25, 1)
INSERT INTO CAUHOI
    (MACH, NOIDUNGCH,DIEM, DOKHO)
VALUES('CH02', 'DEF', 15, 3)
INSERT INTO CAUHOI
    (MACH, NOIDUNGCH,DIEM, DOKHO)
VALUES('CH03', 'GHI', 5, 5)

INSERT INTO PHUONGAN
    (MAPA, NOIDUNGPA, MACH, LADAPAN)
VALUES('PA01', 'PABC', 'CH01', 1)
INSERT INTO PHUONGAN
    (MAPA, NOIDUNGPA, MACH, LADAPAN)
VALUES('PA02', 'PDEF', 'CH01', 0)
INSERT INTO PHUONGAN
    (MAPA, NOIDUNGPA, MACH, LADAPAN)
VALUES('PA03', 'PGHI', 'CH03', 0)
INSERT INTO PHUONGAN
    (MAPA, NOIDUNGPA, MACH, LADAPAN)
VALUES('PA04', 'PGHI', 'CH02', 1)


INSERT INTO TRALOI
    (SOBD, MACH, MAPA)
VALUES('TS001', 'CH01', 'PA01')
INSERT INTO TRALOI
    (SOBD, MACH, MAPA)
VALUES('TS001', 'CH03', 'PA03')
INSERT INTO TRALOI
    (SOBD, MACH, MAPA)
VALUES('TS002', 'CH01', 'PA02')
INSERT INTO TRALOI
    (SOBD, MACH, MAPA)
VALUES('TS003', 'CH02', 'PA04')
INSERT INTO TRALOI
    (SOBD, MACH, MAPA)
VALUES('TS002', 'CH01', 'PA02')

SELECT *
FROM THISINH TS, PHUONGAN PA, CAUHOI CH, TRALOI TL
WHERE TS.SOBD = TL.SOBD AND PA.MAPA = TL.MAPA AND CH.MACH = TL.MACH
    AND PA.LADAPAN = 1 AND CH.DOKHO = 1
ORDER BY TS.CAPDO ASC

SELECT TOP 1 WITH TIES
    TL.MACH
FROM THISINH TS, TRALOI TL, CAUHOI CH
WHERE TS.CAPDO >=3 AND TS.SOBD = TL.SOBD AND CH.MACH = TL.MACH
GROUP BY TL.MACH
ORDER BY COUNT(TL.MACH) DESC

    SELECT CH.MACH
    FROM CAUHOI CH, THISINH TS, TRALOI TL
    WHERE TS.CAPDO=5 AND TS.SOBD = TL.SOBD AND CH.MACH = TL.MACH
EXCEPT
    SELECT CH.MACH
    FROM CAUHOI CH, THISINH TS, TRALOI TL
    WHERE TS.CAPDO=3 AND TS.SOBD = TL.SOBD AND CH.MACH = TL.MACH


SELECT *
FROM THISINH TS
WHERE NOT EXISTS(
    SELECT *
FROM CAUHOI CH
WHERE CH.DOKHO = 1
    AND NOT EXISTS(
       SELECT *
    FROM TRALOI TL
    WHERE TL.SOBD = TS.SOBD AND TL.MACH = CH.MACH 
    )
)

